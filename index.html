<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --danger-color: #ff6b6b;
            --success-color: #2ecc71;
            /* Gradients */
            --gradient-green: linear-gradient(135deg, #42e695 0%, #3bb2b8 100%);
            --gradient-red: linear-gradient(135deg, #ff8a8a 0%, #ff6b6b 100%);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
        }

        /* --- DASHBOARD VIEW --- */
        #dashboard-view {
            max-width: 800px;
            margin: 0 auto;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: 600;
        }

        .add-page-btn {
            background-color: var(--text-color);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .budget-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            padding-bottom: 40px; 
        }

        .budget-card:active {
            transform: scale(0.98);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 30px;
        }

        .card-total {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-color);
        }

        .card-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
        }

        .card-planned {
            position: absolute;
            bottom: 15px;
            right: 20px;
            font-size: 13px;
            color: #666;
            background-color: rgba(0,0,0,0.05); /* Semi-transparent for colored cards */
            padding: 4px 10px;
            border-radius: 10px;
        }

        .card-delete-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
            z-index: 10;
        }

        .card-delete-btn:hover {
            background-color: rgba(255, 0, 0, 0.1);
        }

        .card-delete-icon {
            width: 18px;
            height: 18px;
            stroke: #999;
            fill: none;
            stroke-width: 2;
            transition: stroke 0.2s;
        }

        .card-delete-btn:hover .card-delete-icon {
            stroke: var(--danger-color);
        }

        /* --- SINGLE PAGE VIEW --- */
        #single-page-view {
            display: none;
            max-width: 500px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            min-height: 80vh;
            flex-direction: column;
            position: relative;
            transition: background-color 0.3s ease; /* Smooth color transition */
        }

        .nav-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            position: relative;
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0 10px 0 0;
            color: #555;
            margin-top: 5px;
        }

        .header-inputs {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Color Picker Styling */
        .color-picker-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .color-dot:hover {
            transform: scale(1.2);
        }

        .color-dot.active {
            border-color: #333;
            transform: scale(1.1);
        }

        .editable-title {
            font-size: 22px;
            font-weight: 600;
            border: none;
            border-bottom: 2px solid transparent;
            width: 100%;
            text-align: center;
            outline: none;
            color: var(--text-color);
            background: transparent;
            margin-bottom: 5px;
        }

        .editable-title:focus {
            border-bottom: 2px solid var(--primary-color);
        }

        .budget-limit-container {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .editable-limit {
            border: none;
            border-bottom: 1px dashed #ccc;
            width: 80px;
            text-align: center;
            font-size: 14px;
            color: #333;
            outline: none;
            background: transparent;
        }

        .total-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }

        .exceeded-text {
            color: #00008b;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            height: 20px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .exceeded-text.visible {
            opacity: 1;
        }

        .total-display {
            background: var(--gradient-green);
            color: white;
            font-size: 32px;
            font-weight: 600;
            text-align: center;
            padding: 15px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            min-width: 120px;
            transition: background 0.5s ease;
        }

        .total-display.over-budget {
            background: var(--gradient-red);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 80px;
        }

        th {
            padding: 10px 5px;
            font-size: 14px;
            color: #666; /* Slightly darker for better contrast on colors */
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }

        td {
            padding: 10px 5px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            position: relative;
        }

        th:nth-child(1) { width: 10%; } 
        th:nth-child(2) { width: 30%; } 
        th:nth-child(3) { width: 35%; } 
        th:nth-child(4) { width: 25%; } 

        input.data-input {
            width: 100%;
            border: none;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            text-align: center;
            outline: none;
            background: transparent;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        .delete-btn-container {
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
            padding: 5px;
            z-index: 10;
        }

        tr:hover .delete-btn-container,
        tr:focus-within .delete-btn-container {
            display: block;
        }

        .delete-icon {
            width: 18px;
            height: 18px;
            stroke: var(--danger-color);
            fill: none;
            stroke-width: 2;
            cursor: pointer;
        }

        .button-container {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
        }

        button.main-btn {
            flex: 1;
            background-color: var(--text-color);
            color: white;
            border: none;
            padding: 14px;
            font-size: 14px;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        button.save-btn {
            background-color: var(--primary-color);
        }
    </style>
</head>
<body>

    <div id="dashboard-view">
        <div class="dashboard-header">
            <div class="dashboard-title">My Pages</div>
            <button class="add-page-btn" onclick="initiateNewPage()">+ Add New Page</button>
        </div>
        <div id="cards-container" class="grid-container">
            </div>
    </div>

    <div id="single-page-view">
        
        <div class="nav-header">
            <button class="back-btn" onclick="goBackToDashboard()">&#8592;</button>
            <div class="header-inputs">
                <div class="color-picker-container">
                    <div class="color-dot" style="background: #ffffff;" onclick="changePageColor('#ffffff', this)" title="White"></div>
                    <div class="color-dot" style="background: #e3f2fd;" onclick="changePageColor('#e3f2fd', this)" title="Soft Blue"></div>
                    <div class="color-dot" style="background: #e8f5e9;" onclick="changePageColor('#e8f5e9', this)" title="Soft Green"></div>
                    <div class="color-dot" style="background: #f3e5f5;" onclick="changePageColor('#f3e5f5', this)" title="Soft Purple"></div>
                    <div class="color-dot" style="background: #fce4ec;" onclick="changePageColor('#fce4ec', this)" title="Soft Pink"></div>
                    <div class="color-dot" style="background: #fff3e0;" onclick="changePageColor('#fff3e0', this)" title="Soft Peach"></div>
                </div>

                <input type="text" id="page-title-input" class="editable-title" placeholder="Page Title">
                <div class="budget-limit-container">
                    Planned Budget: <input type="number" id="page-limit-input" class="editable-limit" placeholder="0" oninput="calculateTotal()">
                </div>
            </div>
        </div>

        <div class="total-section">
            <div class="exceeded-text" id="exceededText">+0</div>
            <div class="total-display" id="totalBox">0</div>
        </div>

        <table id="expenseTable">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Date</th>
                    <th>Item</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>

        <div class="button-container">
            <button class="main-btn" onclick="addNewRow()">+ Add Row</button>
            <button class="main-btn save-btn" onclick="saveCurrentPage()">Save</button>
        </div>
    </div>

    <script>
        // Global State
        let allPages = [];
        let currentPageId = null;
        let currentColor = "#ffffff"; // Default

        window.onload = function() {
            loadAllData();
        };

        function loadAllData() {
            const storedData = localStorage.getItem('foodBudgetApp');
            if (storedData) {
                const parsed = JSON.parse(storedData);
                // Migration Check
                if (Array.isArray(parsed) && parsed.length > 0 && parsed[0].hasOwnProperty('amount') && !parsed[0].hasOwnProperty('rows')) {
                    allPages = [{ id: Date.now(), title: "Food Budget", limit: 0, theme: "#ffffff", rows: parsed }];
                    saveToLocalStorage();
                } else if (Array.isArray(parsed)) {
                    allPages = parsed;
                }
            } else {
                allPages = [];
            }
            renderDashboard();
        }

        function saveToLocalStorage() {
            localStorage.setItem('foodBudgetApp', JSON.stringify(allPages));
        }

        function renderDashboard() {
            const container = document.getElementById('cards-container');
            container.innerHTML = ''; 

            allPages.forEach(page => {
                let total = 0;
                if(page.rows) page.rows.forEach(r => total += (parseFloat(r.amount) || 0));

                const card = document.createElement('div');
                card.className = 'budget-card';
                
                // Apply the saved background color to the card too!
                card.style.backgroundColor = page.theme || '#ffffff';
                
                card.onclick = () => openPage(page.id);

                const trashIcon = `<svg class="card-delete-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                const limitDisplay = page.limit ? page.limit : 0;

                card.innerHTML = `
                    <button class="card-delete-btn" onclick="deletePage(${page.id}, event)">${trashIcon}</button>
                    <div class="card-title">${page.title}</div>
                    <div class="card-label">Total Expense</div>
                    <div class="card-total" style="color: ${total > limitDisplay && limitDisplay > 0 ? '#ff6b6b' : '#333'}">${total}</div>
                    <div class="card-planned">Planned: ${limitDisplay}</div>
                `;
                container.appendChild(card);
            });
        }

        function initiateNewPage() {
            const title = prompt("Enter Name for new Sheet:", "New Budget");
            if (title === null) return; 

            let limit = prompt("Enter Planned Budget Amount:", "0");
            if (limit === null) limit = 0; 

            createNewPage(title, parseFloat(limit));
        }

        function createNewPage(title, limit) {
            const newPage = {
                id: Date.now(),
                title: title,
                limit: limit,
                theme: "#ffffff", // Default White
                rows: [] 
            };
            allPages.push(newPage);
            saveToLocalStorage();
            renderDashboard();
            openPage(newPage.id);
        }

        function deletePage(id, event) {
            event.stopPropagation();
            const pageIndex = allPages.findIndex(p => p.id === id);
            if (pageIndex === -1) return;
            if (confirm(`Delete "${allPages[pageIndex].title}"?`)) {
                allPages.splice(pageIndex, 1);
                saveToLocalStorage();
                renderDashboard();
            }
        }

        function openPage(id) {
            currentPageId = id;
            const pageData = allPages.find(p => p.id === id);
            if(!pageData) return;

            document.getElementById('dashboard-view').style.display = 'none';
            const pageView = document.getElementById('single-page-view');
            pageView.style.display = 'flex';

            document.getElementById('page-title-input').value = pageData.title;
            document.getElementById('page-limit-input').value = pageData.limit || 0;

            // --- Apply Color ---
            currentColor = pageData.theme || '#ffffff';
            pageView.style.backgroundColor = currentColor;
            updateActiveColorDot(currentColor);

            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            if (pageData.rows && pageData.rows.length > 0) {
                pageData.rows.forEach(row => renderRowHTML(row.date, row.item, row.amount));
            } else {
                addNewRow(); 
            }

            calculateTotal();
        }

        // --- NEW: Color Picker Logic ---
        function changePageColor(color, dotElement) {
            currentColor = color;
            document.getElementById('single-page-view').style.backgroundColor = color;
            
            // Visual feedback on the dots
            const allDots = document.querySelectorAll('.color-dot');
            allDots.forEach(d => d.classList.remove('active'));
            if(dotElement) dotElement.classList.add('active');
        }

        function updateActiveColorDot(color) {
            const allDots = document.querySelectorAll('.color-dot');
            allDots.forEach(d => {
                // Check if this dot's background color matches the saved hex
                // (Browser converts hex to rgb, so we check approximate match or style attr)
                d.classList.remove('active');
                // Simple check based on the style attribute we set in HTML
                if(d.getAttribute('style').includes(color)) {
                    d.classList.add('active');
                }
            });
        }

        function goBackToDashboard() {
            document.getElementById('single-page-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'block';
            renderDashboard();
            currentPageId = null;
        }

        function calculateTotal() {
            let total = 0;
            const amounts = document.querySelectorAll('.amount-input');
            amounts.forEach(input => {
                const val = parseFloat(input.value);
                if (!isNaN(val)) total += val;
            });

            const totalBox = document.getElementById('totalBox');
            const exceededText = document.getElementById('exceededText');
            const limitInput = document.getElementById('page-limit-input');
            const limit = parseFloat(limitInput.value) || 0;

            totalBox.innerText = total;

            if (limit > 0 && total > limit) {
                totalBox.classList.add('over-budget'); 
                const diff = total - limit;
                exceededText.innerText = `+${diff}`;
                exceededText.classList.add('visible'); 
            } else {
                totalBox.classList.remove('over-budget'); 
                exceededText.classList.remove('visible'); 
            }
        }

        function addNewRow(dateVal = '', itemVal = '', amountVal = '') {
            let defaultDate = dateVal;
            if (!defaultDate) {
                const today = new Date();
                defaultDate = today.toISOString().split('T')[0];
            }
            renderRowHTML(defaultDate, itemVal, amountVal);
        }

        function renderRowHTML(dateVal, itemVal, amountVal) {
            const tableBody = document.getElementById('tableBody');
            const rowCount = tableBody.rows.length + 1;
            const row = document.createElement('tr');

            const deleteIconSVG = `<svg class="delete-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;

            row.innerHTML = `
                <td class="row-num" style="text-align:center;">${rowCount}</td>
                <td><input type="date" class="data-input date-input" value="${dateVal}"></td>
                <td><input type="text" class="data-input item-input" placeholder="Name" value="${itemVal}"></td>
                <td style="position: relative;">
                    <input type="number" class="data-input amount-input" placeholder="0" value="${amountVal}" oninput="calculateTotal()">
                    <div class="delete-btn-container" onclick="deleteRow(this)">${deleteIconSVG}</div>
                </td>
            `;
            tableBody.appendChild(row);
        }

        function deleteRow(btnContainer) {
            const row = btnContainer.parentNode.parentNode;
            row.remove();
            renumberRows();
            calculateTotal();
        }

        function renumberRows() {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach((row, index) => {
                row.querySelector('.row-num').innerText = index + 1;
            });
        }

        function saveCurrentPage() {
            if (!currentPageId) return;

            const rows = document.querySelectorAll('#tableBody tr');
            let newRowsData = [];
            rows.forEach(row => {
                const date = row.querySelector('.date-input').value;
                const item = row.querySelector('.item-input').value;
                const amount = row.querySelector('.amount-input').value;
                if(date || item || amount) {
                    newRowsData.push({ date, item, amount });
                }
            });

            const currentTitle = document.getElementById('page-title-input').value;
            const currentLimit = document.getElementById('page-limit-input').value;

            const pageIndex = allPages.findIndex(p => p.id === currentPageId);
            if (pageIndex > -1) {
                allPages[pageIndex].rows = newRowsData;
                allPages[pageIndex].title = currentTitle;
                allPages[pageIndex].limit = parseFloat(currentLimit) || 0;
                allPages[pageIndex].theme = currentColor; // Save the color
            }

            saveToLocalStorage();

            const saveBtn = document.querySelector('.save-btn');
            const originalText = saveBtn.innerText;
            saveBtn.innerText = "Saved!";
            saveBtn.style.backgroundColor = "#27ae60"; 
            setTimeout(() => {
                saveBtn.innerText = originalText;
                saveBtn.style.backgroundColor = "";
            }, 1500);
        }
    </script>
</body>
</html>
